const path = require("path");
const fs = require("fs");
const { createCanvas, loadImage, registerFont } = require("canvas");
const QRCode = require("qrcode");
const RestaurantModel = require("../models/restaurant-model");

module.exports.GenerateQRCode = async (req, res) => {
  try {
    if (!req.user?.id) {
      return res.status(401).json({ message: "Unauthorized" });
    }

    const restaurant = await RestaurantModel.findById(req.user.id);
    if (!restaurant) {
      return res.status(404).json({ message: "Restaurant not found" });
    }

    const slug = restaurant.slug;
    const restaurantName = restaurant.restaurantName;
    const qrUrl = `${process.env.FRONTEND_URI}menu/${slug}`;
    const qrDataUrl = await QRCode.toDataURL(qrUrl, {
      errorCorrectionLevel: "L",
      type: "image/png",
      width: 300,
    });

    let fontPathManrope = path.join(
      __dirname,
      "../public/fonts/Oswald/Oswald-VariableFont_wght.ttf"
    );
    console.log(fontPathManrope);
    registerFont(fontPathManrope, { family: "Oswald" });
    // Generate QR Code as a data URL
    // Canvas size: QR + space for text
    const scaleFactor = 3; // or 3 for even higher resolution
    const width = 400 * scaleFactor;
    const height = 500 * scaleFactor;
    const canvas = createCanvas(width, height);
    const ctx = canvas.getContext("2d");

    // Fill white background
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, width, height);

    // Load QR Code and draw it
    const qrImage = await loadImage(qrDataUrl);
    ctx.drawImage(
      qrImage,
      50 * scaleFactor,
      50 * scaleFactor,
      300 * scaleFactor,
      300 * scaleFactor
    );

    // Draw Restaurant Name

    ctx.font = `${20 * scaleFactor}px Oswald`;
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.fillText(restaurantName, width / 2, 380 * scaleFactor);

    ctx.font = `${10 * scaleFactor}px Oswald`;
    // Draw "Generated by DigiDine"
    ctx.fillStyle = "#888";
    ctx.fillText("Generated by DigiDine", 330 * scaleFactor, 490 * scaleFactor);

    // Save final image
    const qrDir = path.join(__dirname, "../public/uploads/user/qr-code");
    fs.mkdirSync(qrDir, { recursive: true });

    const filePath = path.join(qrDir, `${slug}.png`);
    const buffer = canvas.toBuffer("image/png");
    fs.writeFileSync(filePath, buffer);

    const relativePath = `/uploads/user/qr-code/${slug}.png`;

    return res.status(200).json({
      message: "Custom QR Code generated",
      qrCodeUrl: relativePath,
    });
  } catch (err) {
    console.error("QR Code generation failed:", err);
    return res.status(500).json({ message: "QR Code generation failed" });
  }
};
